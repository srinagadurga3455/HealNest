<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HealNest - Dashboard</title>
    <link rel="shortcut icon" type="image/png" href="../calm_clarity/assets/images/logos/favicon.png" />
    <link rel="stylesheet" href="../calm_clarity/assets/css/styles.min.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <style>
        .stats-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .stats-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .progress-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--primary, #5D87FF) 0% 85%, #e9ecef 85% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 8px 25px rgba(93, 135, 255, 0.3);
        }
        .progress-text {
            background: white;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--primary, #5D87FF);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .mood-tracker {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .mood-option {
            text-align: center;
            cursor: pointer;
            padding: 1rem;
            border-radius: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            flex: 1;
        }
        .mood-option:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .mood-option.selected {
            background: var(--gradient-primary, linear-gradient(135deg, #5D87FF 0%, #49BEFF 100%));
            color: white;
            border-color: var(--primary, #5D87FF);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(93, 135, 255, 0.4);
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .task-item:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: var(--primary, #5D87FF);
        }
        .task-checkbox {
            margin-right: 1rem;
            transform: scale(1.3);
            accent-color: var(--primary, #5D87FF);
        }
        .welcome-section {
            background: var(--gradient-primary, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
            color: white;
            padding: 2.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(93, 135, 255, 0.3);
        }
        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.1"/></svg>');
            pointer-events: none;
        }
        .quick-action-btn {
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin: 0.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            text-decoration: none;
        }
        
        /* Enhanced card animations */
        .card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        /* Program assignment card */
        .program-assignment-card {
            background: linear-gradient(135deg, #5D87FF 0%, #49BEFF 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .program-assignment-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        
        /* Wellness program cards */
        .border-primary { border-color: var(--primary, #5D87FF) !important; }
        .border-success { border-color: var(--success, #20c997) !important; }
        .border-info { border-color: var(--info, #539BFF) !important; }
        .border-warning { border-color: var(--warning, #FFD666) !important; }
        
        /* Progress bars */
        .progress {
            border-radius: 10px;
            overflow: hidden;
            background-color: rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            border-radius: 10px;
            transition: width 0.6s ease;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary, #5D87FF);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark, #3B7BFF);
        }
    </style>
</head>

<body>
    <!--  Body Wrapper -->
    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
        data-sidebar-position="fixed" data-header-position="fixed">
        <!-- Sidebar Start -->
        <aside class="left-sidebar">
            <!-- Sidebar scroll-->
            <div>
                <div class="brand-logo d-flex align-items-center justify-content-between">
                    <a href="./dashboard.html" class="text-nowrap logo-img d-flex align-items-center gap-2">
                        <h1 class="mb-0 fw-900 text-primary" style="font-size: 1.8rem; letter-spacing: 1px;">HealNest</h1>
                    </a>
                    <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
                        <i class="ti ti-x fs-8"></i>
                    </div>
                </div>
                <!-- Sidebar navigation-->
                <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
                    <ul id="sidebarnav">
                        <li class="nav-small-cap">
                            <span class="hide-menu">MAIN</span>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link active" href="./dashboard.html">
                                <i class="ti ti-layout-dashboard"></i>
                                <span class="hide-menu">Dashboard</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="./program.html">
                                <i class="ti ti-target"></i>
                                <span class="hide-menu">My Program</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="#" onclick="scrollToTasks()">
                                <i class="ti ti-list-check"></i>
                                <span class="hide-menu">Today's Tasks</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a class="sidebar-link" href="./profile.html">
                                <i class="ti ti-user"></i>
                                <span class="hide-menu">Profile</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>
        <!--  Main wrapper -->
        <div class="body-wrapper">
            <!--  Header Start -->
            <header class="app-header">
                <nav class="navbar navbar-expand-lg navbar-light">
                    <ul class="navbar-nav">
                        <li class="nav-item d-block d-xl-none">
                            <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                                <i class="ti ti-menu-2"></i>
                            </a>
                        </li>
                    </ul>
                    <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                            <li class="nav-item">
                                <span class="text-muted me-3" id="welcomeText">Welcome back!</span>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown">
                                    <div id="userAvatar" style="width: 35px; height: 35px; border-radius: 50%; background: #5D87FF; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">U</div>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                                    <div class="message-body">
                                        <a href="./profile.html" class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-user fs-6"></i>
                                            <p class="mb-0 fs-3">My Profile</p>
                                        </a>
                                        <a href="./journal.html" class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-edit fs-6"></i>
                                            <p class="mb-0 fs-3">Journal</p>
                                        </a>
                                        <a href="./landing.html" class="d-flex align-items-center gap-2 dropdown-item" onclick="logout()">
                                            <i class="ti ti-logout fs-6"></i>
                                            <p class="mb-0 fs-3">Logout</p>
                                        </a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>
            <!--  Header End -->
            <div class="container-fluid">
                <!-- Welcome Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="welcome-section">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h2 class="mb-2"><span id="greeting">Good morning</span>, <span id="userName">User</span>! ðŸŒŸ</h2>
                                    <p class="mb-0 fs-5">Your personal mental wellness companion. Track your mood, complete tasks, and grow on your wellness journey.</p>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="progress-circle">
                                        <div class="progress-text" id="wellnessScore">85%</div>
                                    </div>
                                    <p class="mt-2 mb-0">Wellness Score</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Program Assignment Card -->
                <div class="row mb-4" id="programAssignmentSection">
                    <div class="col-12">
                        <div class="program-assignment-card">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h4 class="mb-2" id="programName">ðŸŽ¯ Your Wellness Program</h4>
                                    <p class="mb-2" id="programDescription">Loading your personalized program...</p>
                                    <small id="programReason" style="opacity: 0.9;">Based on your assessment results</small>
                                </div>
                                <div class="col-md-4 text-center">
                                    <button class="btn btn-light btn-lg" onclick="scrollToTasks()">
                                        âœ… Complete Today's Tasks
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Row -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <i class="ti ti-flame text-danger" style="font-size: 2rem;"></i>
                                </div>
                                <h4 class="text-danger fw-bold" id="currentStreak">0</h4>
                                <p class="text-muted mb-0">Current Streak</p>
                                <small class="text-success">Keep it up!</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <i class="ti ti-trophy text-warning" style="font-size: 2rem;"></i>
                                </div>
                                <h4 class="text-warning fw-bold" id="maxStreak">0</h4>
                                <p class="text-muted mb-0">Max Streak</p>
                                <small class="text-success">Personal best!</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <i class="ti ti-calendar text-primary" style="font-size: 2rem;"></i>
                                </div>
                                <h4 class="text-primary fw-bold" id="programDays">0</h4>
                                <p class="text-muted mb-0">Program Days</p>
                                <small class="text-success">Days active</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <i class="ti ti-book text-info" style="font-size: 2rem;"></i>
                                </div>
                                <h4 class="text-info fw-bold" id="journalCount">0</h4>
                                <p class="text-muted mb-0">Journal Entries</p>
                                <small class="text-success">Great progress!</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Row -->
                <div class="row">
                    <!-- Today's Tasks -->
                    <div class="col-lg-6">
                        <div class="card" id="tasksSection">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center">
                                    <i class="ti ti-list-check me-2 text-primary"></i>
                                    Today's Tasks
                                </h5>
                                <div id="tasks-list">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mood Tracker & Journal -->
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center">
                                    <i class="ti ti-mood-happy me-2 text-success"></i>
                                    How are you feeling today?
                                </h5>
                                <div class="mood-tracker">
                                    <div class="mood-option" data-mood="excellent">
                                        <i class="ti ti-mood-happy" style="font-size: 2rem;"></i>
                                        <div>Excellent</div>
                                    </div>
                                    <div class="mood-option" data-mood="good">
                                        <i class="ti ti-mood-smile" style="font-size: 2rem;"></i>
                                        <div>Good</div>
                                    </div>
                                    <div class="mood-option" data-mood="neutral">
                                        <i class="ti ti-mood-neutral" style="font-size: 2rem;"></i>
                                        <div>Neutral</div>
                                    </div>
                                    <div class="mood-option" data-mood="challenging">
                                        <i class="ti ti-mood-sad" style="font-size: 2rem;"></i>
                                        <div>Challenging</div>
                                    </div>
                                </div>
                                <div id="mood-feedback" class="mt-3 text-center" style="display: none;">
                                    <p class="mb-0 text-success">Thanks for sharing! Your mood has been recorded.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Journal Entries -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center justify-content-between">
                                    <span><i class="ti ti-edit me-2 text-info"></i>Recent Journal Entries</span>
                                    <a href="./journal.html" class="btn btn-sm btn-outline-primary">Write Entry</a>
                                </h5>
                                <div id="journal-entries">
                                    <!-- Journal entries will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../calm_clarity/assets/libs/jquery/dist/jquery.min.js"></script>
    <script src="../calm_clarity/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../calm_clarity/assets/js/sidebarmenu.js"></script>
    <script src="../calm_clarity/assets/js/app.min.js"></script>
    <script src="../js/main.js"></script>
    
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication and program assignment
            if (!Auth.isLoggedIn()) {
                window.location.href = './login.html';
                return;
            }
            
            // Check if user has program assigned - if not, redirect to assessment
            const user = Auth.getCurrentUser();
            if (!user.assigned_program_id && !localStorage.getItem('healNestAssessmentCompleted')) {
                window.location.href = './assessment.html';
                return;
            }
            
            loadUserInfo();
            loadStats();
            loadTodaysMood();
            loadJournalEntries();
            loadTodaysTasks();
            loadProgramInfo();
            
            // Setup mood tracker
            setupMoodTracker();
        });

        function loadUserInfo() {
            const user = Auth.getCurrentUser();
            const greeting = getGreeting();
            
            document.getElementById('greeting').textContent = greeting;
            document.getElementById('userName').textContent = user.fullName || user.name || user.email.split('@')[0];
            document.getElementById('headerUserName').textContent = user.fullName || user.name || user.email.split('@')[0];
            document.getElementById('userEmail').textContent = user.email;
            
            // Set user avatar
            const userAvatar = document.getElementById('userAvatar');
            const userName = user.fullName || user.name || user.email;
            userAvatar.textContent = userName.charAt(0).toUpperCase();
        }

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good morning';
            if (hour < 18) return 'Good afternoon';
            return 'Good evening';
        }

        function loadStats() {
            const user = Auth.getCurrentUser();
            const journalEntries = Journal.getEntries();
            const moodData = MoodTracker.getMoodData();
            
            // Calculate streak data
            const currentStreak = user.current_streak || calculateCurrentStreak();
            const maxStreak = user.highest_streak || Math.max(currentStreak, 5);
            const programDays = user.total_program_days || calculateProgramDays();
            
            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('maxStreak').textContent = maxStreak;
            document.getElementById('programDays').textContent = programDays;
            document.getElementById('journalCount').textContent = journalEntries.length;
        }

        function calculateCurrentStreak() {
            const moodData = MoodTracker.getMoodData();
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                if (moodData[dateString]) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return Math.max(streak, 3); // Minimum 3 for demo
        }

        function calculateProgramDays() {
            const user = Auth.getCurrentUser();
            if (user.program_start_date) {
                const startDate = new Date(user.program_start_date);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }
            return Math.floor(Math.random() * 30) + 1; // Random for demo
        }

        function loadTodaysMood() {
            const todayMood = MoodTracker.getTodayMood();
            if (todayMood) {
                document.querySelector(`[data-mood="${todayMood.mood}"]`).classList.add('selected');
            }
        }

        function setupMoodTracker() {
            document.querySelectorAll('.mood-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    const mood = this.dataset.mood;
                    
                    // Save mood
                    MoodTracker.saveMood(mood, '');
                    
                    // Show feedback
                    const feedback = document.getElementById('moodFeedback');
                    feedback.style.display = 'block';
                    
                    setTimeout(() => {
                        feedback.style.display = 'none';
                    }, 3000);
                    
                    // Refresh stats
                    loadStats();
                });
            });
        }

        function loadJournalEntries() {
            const entries = Journal.getEntries().slice(-3).reverse();
            const container = document.getElementById('journalEntries');
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>ðŸ“”</i>
                        <p>No journal entries yet</p>
                        <a href="./journal.html" class="btn-primary">Write Your First Entry</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = entries.map(entry => `
                <div class="journal-entry" onclick="window.location.href='./journal.html'">
                    <div class="entry-title">${entry.title}</div>
                    <div class="entry-preview">${truncateText(entry.content, 80)}</div>
                    <div class="entry-meta">
                        <span>${formatRelativeTime(entry.createdAt)}</span>
                        <span>${getMoodEmoji(entry.mood)}</span>
                    </div>
                </div>
            `).join('');
        }

        function loadTodaysTasks() {
            // Get program-specific tasks
            const programTasks = JSON.parse(localStorage.getItem('healNestProgramTasks') || '[]');
            const completedTasks = JSON.parse(localStorage.getItem('healNestCompletedTasks') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const todayCompleted = completedTasks.filter(task => task.date === today);
            
            const container = document.getElementById('todaysTasks');
            
            if (programTasks.length === 0) {
                container.innerHTML = `
                    <li class="empty-state">
                        <i>âœ…</i>
                        <p>Complete your assessment to get personalized tasks</p>
                    </li>
                `;
                return;
            }
            
            container.innerHTML = programTasks.map(task => {
                const isCompleted = todayCompleted.some(completed => completed.taskId === task.id);
                return `
                    <li class="task-item">
                        <input type="checkbox" class="task-checkbox" ${isCompleted ? 'checked' : ''} 
                               onchange="toggleProgramTask(${task.id})">
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                            <div class="task-description">${task.description}</div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function toggleProgramTask(taskId) {
            const today = new Date().toISOString().split('T')[0];
            let completedTasks = JSON.parse(localStorage.getItem('healNestCompletedTasks') || '[]');
            
            // Check if task is already completed today
            const existingIndex = completedTasks.findIndex(task => 
                task.taskId === taskId && task.date === today
            );
            
            if (existingIndex >= 0) {
                // Remove completion
                completedTasks.splice(existingIndex, 1);
            } else {
                // Add completion
                completedTasks.push({
                    taskId: taskId,
                    date: today,
                    completedAt: new Date().toISOString()
                });
                
                // Update streak
                updateStreak();
            }
            
            localStorage.setItem('healNestCompletedTasks', JSON.stringify(completedTasks));
        }

        function loadProgramInfo() {
            const user = Auth.getCurrentUser();
            const programCard = document.getElementById('programInfoCard');
            
            if (!user.assigned_program_id && !localStorage.getItem('healNestAssessmentCompleted')) {
                programCard.innerHTML = `
                    <div class="program-content">
                        <h4 class="mb-2">ðŸŽ¯ Complete Your Assessment</h4>
                        <p class="mb-2">Take our wellness assessment to get your personalized program</p>
                        <a href="./assessment.html" class="complete-tasks-btn">Take Assessment Now</a>
                    </div>
                `;
                return;
            }
            
            // Program data with tasks
            const programs = {
                1: {
                    name: 'Mindfulness & Stress Relief',
                    description: 'Daily meditation and stress management techniques to help you find inner peace and reduce anxiety.',
                    reason: 'Your assessment shows elevated stress levels. This program will help you develop coping strategies.',
                    tasks: [
                        { id: 1, title: 'Morning Meditation', description: '10 minutes of guided mindfulness meditation' },
                        { id: 2, title: 'Breathing Exercise', description: '5-minute deep breathing for stress relief' },
                        { id: 3, title: 'Stress Level Check', description: 'Rate and reflect on your stress level (1-10)' }
                    ]
                },
                2: {
                    name: 'Emotional Balance & Resilience',
                    description: 'Build emotional intelligence and resilience through targeted exercises and journaling.',
                    reason: 'Your responses indicate mood fluctuations. This program focuses on emotional stability.',
                    tasks: [
                        { id: 1, title: 'Emotion Check-in', description: 'Identify and name your current emotions' },
                        { id: 2, title: 'Gratitude Journal', description: 'Write 3 things you are grateful for today' },
                        { id: 3, title: 'Positive Affirmations', description: 'Recite 5 positive affirmations about yourself' }
                    ]
                },
                3: {
                    name: 'Sleep Optimization & Recovery',
                    description: 'Improve sleep quality and establish healthy sleep habits for better energy and wellness.',
                    reason: 'Your assessment shows sleep-related concerns. Better sleep will improve your overall wellness.',
                    tasks: [
                        { id: 1, title: 'Sleep Schedule Check', description: 'Go to bed at your target time' },
                        { id: 2, title: 'Screen Time Limit', description: 'No screens 1 hour before bedtime' },
                        { id: 3, title: 'Relaxation Routine', description: 'Practice your bedtime relaxation routine' }
                    ]
                },
                4: {
                    name: 'Anxiety Management & Coping',
                    description: 'Learn evidence-based techniques to manage anxiety and build confidence in daily situations.',
                    reason: 'Your responses suggest anxiety symptoms. This program provides practical coping tools.',
                    tasks: [
                        { id: 1, title: 'Anxiety Breathing', description: '4-7-8 breathing technique for anxiety relief' },
                        { id: 2, title: 'Grounding Exercise', description: '5-4-3-2-1 grounding technique when feeling anxious' },
                        { id: 3, title: 'Worry Time', description: 'Dedicated 10 minutes to process worries constructively' }
                    ]
                },
                5: {
                    name: 'Self-Confidence & Personal Growth',
                    description: 'Build self-esteem and develop leadership skills through daily challenges and goal-setting.',
                    reason: 'Your assessment indicates potential for growth. This program will boost your confidence.',
                    tasks: [
                        { id: 1, title: 'Goal Review', description: 'Review and update your daily goals' },
                        { id: 2, title: 'Confidence Building', description: 'Complete one task outside your comfort zone' },
                        { id: 3, title: 'Self-Reflection', description: 'Reflect on your progress and learnings' }
                    ]
                }
            };
            
            const programId = user.assigned_program_id || 1;
            const program = programs[programId];
            const progress = Math.floor(Math.random() * 100); // Mock progress
            
            // Update program info
            document.getElementById('programName').textContent = program.name;
            document.getElementById('programDescription').textContent = program.description;
            document.getElementById('programReason').textContent = program.reason;
            document.getElementById('programProgress').textContent = progress + '%';
            
            // Store program tasks for today's tasks
            localStorage.setItem('healNestProgramTasks', JSON.stringify(program.tasks));
        }

        function addCustomTask() {
            const taskTitle = prompt('Enter task title:');
            if (!taskTitle) return;
            
            const taskDescription = prompt('Enter task description (optional):') || '';
            
            // Add to program tasks
            let programTasks = JSON.parse(localStorage.getItem('healNestProgramTasks') || '[]');
            const newTask = {
                id: Date.now(),
                title: taskTitle,
                description: taskDescription
            };
            
            programTasks.push(newTask);
            localStorage.setItem('healNestProgramTasks', JSON.stringify(programTasks));
            
            loadTodaysTasks();
        }

        function updateStreak() {
            // This would normally update the database
            // For now, just refresh the stats
            loadStats();
        }

        function showTodaysTasks() {
            // Scroll to tasks section
            document.getElementById('todaysTasks').scrollIntoView({ behavior: 'smooth' });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                Auth.logout();
                window.location.href = './landing.html';
            }
        }

        // Utility functions
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength) + '...';
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} days ago`;
            
            return date.toLocaleDateString();
        }

        function getMoodEmoji(mood) {
            const emojis = {
                excellent: 'ðŸ˜„',
                good: 'ðŸ˜Š',
                neutral: 'ðŸ˜',
                challenging: 'ðŸ˜”',
                difficult: 'ðŸ˜¢'
            };
            return emojis[mood] || 'ðŸ˜';
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !mobileBtn.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });
    </script>
</body>
</html>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication and program assignment
            if (!Auth.isLoggedIn()) {
                window.location.href = './login.html';
                return;
            }
            
            // Check if user has program assigned - if not, redirect to assessment
            const user = Auth.getCurrentUser();
            if (!user.assigned_program_id && !localStorage.getItem('healNestAssessmentCompleted')) {
                window.location.href = './assessment.html';
                return;
            }
            
            loadUserInfo();
            loadProgramInfo();
            loadStats();
            loadTodaysMood();
            loadJournalEntries();
            loadTodaysTasks();
            
            // Setup mood tracker
            setupMoodTracker();
            setupTaskHandlers();
        });

        function loadUserInfo() {
            const user = Auth.getCurrentUser();
            const greeting = getGreeting();
            
            document.getElementById('greeting').textContent = greeting;
            document.getElementById('userName').textContent = user.fullName || user.name || user.email.split('@')[0];
            document.getElementById('welcomeText').textContent = `Welcome back, ${user.fullName || user.name || user.email.split('@')[0]}!`;
            
            // Set user avatar
            const userAvatar = document.getElementById('userAvatar');
            const userName = user.fullName || user.name || user.email;
            userAvatar.textContent = userName.charAt(0).toUpperCase();
        }

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good morning';
            if (hour < 18) return 'Good afternoon';
            return 'Good evening';
        }

        function loadProgramInfo() {
            const user = Auth.getCurrentUser();
            
            if (!user.assigned_program_id && !localStorage.getItem('healNestAssessmentCompleted')) {
                document.getElementById('programAssignmentSection').innerHTML = `
                    <div class="col-12">
                        <div class="program-assignment-card">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h4 class="mb-2">ðŸŽ¯ Complete Your Assessment</h4>
                                    <p class="mb-2">Take our wellness assessment to get your personalized program and tasks</p>
                                    <small style="opacity: 0.9;">Get started with your mental health journey</small>
                                </div>
                                <div class="col-md-4 text-center">
                                    <a href="./assessment.html" class="btn btn-light btn-lg">Take Assessment Now</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Program data with tasks
            const programs = {
                1: {
                    name: 'Mindfulness & Stress Relief',
                    description: 'Daily meditation and stress management techniques to help you find inner peace and reduce anxiety.',
                    reason: 'Your assessment shows elevated stress levels. This program will help you develop coping strategies.',
                    tasks: [
                        { id: 1, title: 'Morning Meditation', description: '10 minutes of guided mindfulness meditation', completed: false },
                        { id: 2, title: 'Breathing Exercise', description: '5-minute deep breathing for stress relief', completed: false },
                        { id: 3, title: 'Stress Level Check', description: 'Rate and reflect on your stress level (1-10)', completed: false }
                    ]
                },
                2: {
                    name: 'Emotional Balance & Resilience',
                    description: 'Build emotional intelligence and resilience through targeted exercises and journaling.',
                    reason: 'Your responses indicate mood fluctuations. This program focuses on emotional stability.',
                    tasks: [
                        { id: 1, title: 'Emotion Check-in', description: 'Identify and name your current emotions', completed: false },
                        { id: 2, title: 'Gratitude Journal', description: 'Write 3 things you are grateful for today', completed: false },
                        { id: 3, title: 'Positive Affirmations', description: 'Recite 5 positive affirmations about yourself', completed: false }
                    ]
                },
                3: {
                    name: 'Sleep Optimization & Recovery',
                    description: 'Improve sleep quality and establish healthy sleep habits for better energy and wellness.',
                    reason: 'Your assessment shows sleep-related concerns. Better sleep will improve your overall wellness.',
                    tasks: [
                        { id: 1, title: 'Sleep Schedule Check', description: 'Go to bed at your target time', completed: false },
                        { id: 2, title: 'Screen Time Limit', description: 'No screens 1 hour before bedtime', completed: false },
                        { id: 3, title: 'Relaxation Routine', description: 'Practice your bedtime relaxation routine', completed: false }
                    ]
                },
                4: {
                    name: 'Anxiety Management & Coping',
                    description: 'Learn evidence-based techniques to manage anxiety and build confidence in daily situations.',
                    reason: 'Your responses suggest anxiety symptoms. This program provides practical coping tools.',
                    tasks: [
                        { id: 1, title: 'Anxiety Breathing', description: '4-7-8 breathing technique for anxiety relief', completed: false },
                        { id: 2, title: 'Grounding Exercise', description: '5-4-3-2-1 grounding technique when feeling anxious', completed: false },
                        { id: 3, title: 'Worry Time', description: 'Dedicated 10 minutes to process worries constructively', completed: false }
                    ]
                },
                5: {
                    name: 'Self-Confidence & Personal Growth',
                    description: 'Build self-esteem and develop leadership skills through daily challenges and goal-setting.',
                    reason: 'Your assessment indicates potential for growth. This program will boost your confidence.',
                    tasks: [
                        { id: 1, title: 'Goal Review', description: 'Review and update your daily goals', completed: false },
                        { id: 2, title: 'Confidence Building', description: 'Complete one task outside your comfort zone', completed: false },
                        { id: 3, title: 'Self-Reflection', description: 'Reflect on your progress and learnings', completed: false }
                    ]
                }
            };
            
            const programId = user.assigned_program_id || 1;
            const program = programs[programId];
            const progress = Math.floor(Math.random() * 100); // Mock progress
            
            // Update program info
            document.getElementById('programName').textContent = program.name;
            document.getElementById('programDescription').textContent = program.description;
            document.getElementById('programReason').textContent = program.reason;
            
            // Store program tasks for today's tasks
            localStorage.setItem('healNestProgramTasks', JSON.stringify(program.tasks));
        }

        function loadStats() {
            const user = Auth.getCurrentUser();
            const journalEntries = Journal.getEntries();
            const moodData = MoodTracker.getMoodData();
            
            // Calculate streak data
            const currentStreak = user.current_streak || calculateCurrentStreak();
            const maxStreak = user.highest_streak || Math.max(currentStreak, 5);
            const programDays = user.total_program_days || calculateProgramDays();
            const wellnessScore = user.wellness_score || 85;
            
            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('maxStreak').textContent = maxStreak;
            document.getElementById('programDays').textContent = programDays;
            document.getElementById('journalCount').textContent = journalEntries.length;
            document.getElementById('wellnessScore').textContent = wellnessScore + '%';
        }

        function calculateCurrentStreak() {
            const moodData = MoodTracker.getMoodData();
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                if (moodData[dateString]) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return Math.max(streak, 3); // Minimum 3 for demo
        }

        function calculateProgramDays() {
            const user = Auth.getCurrentUser();
            if (user.program_start_date) {
                const startDate = new Date(user.program_start_date);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }
            return Math.floor(Math.random() * 30) + 1; // Random for demo
        }

        function loadTodaysMood() {
            const todayMood = MoodTracker.getTodayMood();
            if (todayMood) {
                document.querySelector(`[data-mood="${todayMood.mood}"]`).classList.add('selected');
            }
        }

        function setupMoodTracker() {
            document.querySelectorAll('.mood-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    const mood = this.dataset.mood;
                    
                    // Save mood
                    MoodTracker.saveMood(mood, '');
                    
                    // Show feedback
                    const feedback = document.getElementById('mood-feedback');
                    feedback.style.display = 'block';
                    
                    setTimeout(() => {
                        feedback.style.display = 'none';
                    }, 3000);
                    
                    // Refresh stats
                    loadStats();
                });
            });
        }

        function loadJournalEntries() {
            const entries = Journal.getEntries().slice(-3).reverse();
            const container = document.getElementById('journal-entries');
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="ti ti-book" style="font-size: 2rem; color: #6c757d;"></i>
                        <p class="text-muted mt-2 mb-0">No journal entries yet</p>
                        <a href="./journal.html" class="btn btn-sm btn-primary mt-2">Write Your First Entry</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = entries.map(entry => `
                <div class="border-bottom py-2 cursor-pointer" onclick="window.location.href='./journal.html'">
                    <h6 class="mb-1">${entry.title}</h6>
                    <p class="text-muted small mb-1">${truncateText(entry.content, 60)}</p>
                    <small class="text-muted">${formatRelativeTime(entry.createdAt)} ${getMoodEmoji(entry.mood)}</small>
                </div>
            `).join('');
        }

        function loadTodaysTasks() {
            // Get program-specific tasks only for assigned program
            const user = Auth.getCurrentUser();
            const programTasks = JSON.parse(localStorage.getItem('healNestProgramTasks') || '[]');
            const completedTasks = JSON.parse(localStorage.getItem('healNestCompletedTasks') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const todayCompleted = completedTasks.filter(task => task.date === today);
            
            const container = document.getElementById('tasks-list');
            
            if (!user.assigned_program_id || programTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="ti ti-clipboard-check" style="font-size: 2rem; color: #6c757d;"></i>
                        <p class="text-muted mt-2 mb-0">Complete your assessment to get personalized tasks</p>
                    </div>
                `;
                return;
            }
            
            // Only show tasks from the assigned program
            container.innerHTML = programTasks.map(task => {
                const isCompleted = todayCompleted.some(completed => completed.taskId === task.id);
                return `
                    <div class="task-item">
                        <input type="checkbox" class="task-checkbox" ${isCompleted ? 'checked' : ''} 
                               data-task-id="${task.id}">
                        <div class="flex-grow-1">
                            <div class="fw-semibold">${task.title}</div>
                            <small class="text-muted">${task.description}</small>
                        </div>
                        <small class="${isCompleted ? 'text-success' : 'text-warning'}">${isCompleted ? 'Completed' : 'Pending'}</small>
                    </div>
                `;
            }).join('');
        }

        function setupTaskHandlers() {
            // Use event delegation for task checkboxes
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-checkbox')) {
                    const taskId = parseInt(e.target.dataset.taskId);
                    const today = new Date().toISOString().split('T')[0];
                    let completedTasks = JSON.parse(localStorage.getItem('healNestCompletedTasks') || '[]');
                    
                    // Check if task is already completed today
                    const existingIndex = completedTasks.findIndex(task => 
                        task.taskId === taskId && task.date === today
                    );
                    
                    const taskItem = e.target.closest('.task-item');
                    const statusElement = taskItem.querySelector('small:last-child');
                    
                    if (e.target.checked) {
                        if (existingIndex < 0) {
                            // Add completion
                            completedTasks.push({
                                taskId: taskId,
                                date: today,
                                completedAt: new Date().toISOString()
                            });
                        }
                        statusElement.textContent = 'Completed';
                        statusElement.className = 'text-success';
                        taskItem.style.opacity = '0.7';
                        
                        // Update streak
                        updateStreak();
                    } else {
                        if (existingIndex >= 0) {
                            // Remove completion
                            completedTasks.splice(existingIndex, 1);
                        }
                        statusElement.textContent = 'Pending';
                        statusElement.className = 'text-warning';
                        taskItem.style.opacity = '1';
                    }
                    
                    localStorage.setItem('healNestCompletedTasks', JSON.stringify(completedTasks));
                }
            });
        }

        function updateStreak() {
            // This would normally update the database
            // For now, just refresh the stats
            loadStats();
        }

        function scrollToTasks() {
            document.getElementById('tasksSection').scrollIntoView({ behavior: 'smooth' });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                Auth.logout();
                window.location.href = './landing.html';
            }
        }

        // Utility functions
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength) + '...';
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            
            return date.toLocaleDateString();
        }

        function getMoodEmoji(mood) {
            const emojis = {
                excellent: 'ðŸ˜„',
                good: 'ðŸ˜Š',
                neutral: 'ðŸ˜',
                challenging: 'ðŸ˜”',
                difficult: 'ðŸ˜¢'
            };
            return emojis[mood] || 'ðŸ˜';
        }
    </script>
</body>
</html>