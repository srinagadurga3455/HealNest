<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today's Task - HealNest</title>
    <link rel="stylesheet" href="../redesign/styles.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="./dashboard.html" class="logo" style="display: block; padding: 0 24px; margin-bottom: 32px;">HealNest</a>
            
            <a href="./dashboard.html" class="sidebar-item">Dashboard</a>
            <a href="./program.html" class="sidebar-item active">Today's Task</a>
            <a href="./profile.html" class="sidebar-item">Profile</a>
            
            <a href="#" class="sidebar-item logout" data-logout>Logout</a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <h1 id="taskTitle">Today's Task</h1>
                
                <div class="card" style="margin-bottom: 32px;">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title" id="programName">Loading...</h3>
                            <p class="text-muted" style="margin: 0;" id="taskDate">Today</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 24px;">Today's Practice</h3>
                    <p id="taskDescription">
                        Take 10 minutes to practice mindfulness meditation. Find a quiet space, sit comfortably, and focus on your breathing.
                    </p>

                    <div class="card" style="background: #F5F5F5; border: none; margin: 32px 0;">
                        <h4>How to complete this task:</h4>
                        <ol style="padding-left: 24px;">
                            <li>Find a quiet, comfortable space</li>
                            <li>Set a timer for 10 minutes</li>
                            <li>Focus on your breathing</li>
                            <li>Mark as complete when done</li>
                        </ol>
                    </div>

                    <div class="grid-2">
                        <button class="btn btn-primary" onclick="completeTask()">âœ“ Task Complete</button>
                        <button class="btn btn-secondary" onclick="skipTask()">Skip Today</button>
                    </div>
                </div>

                <div class="card">
                    <h3>What happens next?</h3>
                    <p>Completing your daily task increases your streak and keeps you on track with your wellness goals. Skipping breaks your streak but you can always start fresh tomorrow.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../redesign/app.js"></script>
    <script src="../redesign/programs-data.js"></script>
    <script>
        // Check if user is logged in
        const currentUser = localStorage.getItem('healNestCurrentUser');
        if (!currentUser) {
            window.location.href = './login.html';
        }

        const user = JSON.parse(currentUser);
        if (!user.assessmentCompleted) {
            window.location.href = './assessment.html';
        }

        if (!user.activeProgram) {
            window.location.href = './programs.html';
        }

        // Get current program
        const program = PROGRAMS.find(p => p.name === user.activeProgram);
        if (!program) {
            window.location.href = './programs.html';
        }

        const currentTaskIndex = user.currentTaskIndex || 0;
        const currentTask = program.tasks[currentTaskIndex];
        const progressPercent = ((currentTaskIndex + 1) / program.tasks.length) * 100;

        // Update page
        document.getElementById('taskTitle').textContent = `Day ${currentTask.day} of ${program.duration}`;
        document.getElementById('programName').textContent = program.name;
        document.getElementById('taskDate').textContent = currentTask.day === 1 ? 'Day 1' : `Day ${currentTask.day}`;

        // Progress bar
        const progressHTML = `
            <div class="card" style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span><strong>Progress</strong></span>
                    <span>${currentTaskIndex + 1} of ${program.tasks.length} days</span>
                </div>
                <div style="width: 100%; height: 8px; background: #EBEBEB; border-radius: 4px; overflow: hidden;">
                    <div style="width: ${progressPercent}%; height: 100%; background: linear-gradient(90deg, #0066FF 0%, #7C3AED 100%); transition: width 0.3s;"></div>
                </div>
                <div style="margin-top: 8px; font-size: 14px; color: #999;">${Math.round(progressPercent)}% complete</div>
            </div>
        `;
        document.querySelector('.card').insertAdjacentHTML('afterend', progressHTML);

        // Update task
        document.querySelector('.card h3').textContent = currentTask.title;
        document.querySelector('.card p').textContent = currentTask.description;

        function completeTask() {
            const users = JSON.parse(localStorage.getItem('healNestUsers') || '[]');
            const userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                users[userIndex].currentStreak = (users[userIndex].currentStreak || 0) + 1;
                users[userIndex].totalStreak = (users[userIndex].totalStreak || 0) + 1;
                users[userIndex].completedTasks = users[userIndex].completedTasks || [];
                users[userIndex].completedTasks.push(currentTask.day);
                
                // Track highest streak
                if (!users[userIndex].highestStreak) users[userIndex].highestStreak = 0;
                if (users[userIndex].currentStreak > users[userIndex].highestStreak) {
                    users[userIndex].highestStreak = users[userIndex].currentStreak;
                }
                
                // Move to next task
                if (currentTaskIndex + 1 < program.tasks.length) {
                    users[userIndex].currentTaskIndex = currentTaskIndex + 1;
                    localStorage.setItem('healNestUsers', JSON.stringify(users));
                    
                    const updatedUser = users[userIndex];
                    localStorage.setItem('healNestCurrentUser', JSON.stringify(updatedUser));
                    
                    alert(`Day ${currentTask.day} complete! ${program.tasks.length - currentTaskIndex - 1} days left in your program.`);
                    location.reload();
                } else {
                    // Program complete!
                    users[userIndex].currentTaskIndex = 0;
                    users[userIndex].activeProgram = null;
                    localStorage.setItem('healNestUsers', JSON.stringify(users));
                    
                    const updatedUser = users[userIndex];
                    localStorage.setItem('healNestCurrentUser', JSON.stringify(updatedUser));
                    
                    alert(`ðŸŽ‰ Congratulations! You completed ${program.name}! Your streak: ${users[userIndex].currentStreak} days!`);
                    window.location.href = './dashboard.html';
                }
            }
        }

        function skipTask() {
            if (confirm('Skipping will reset your current streak. Are you sure?')) {
                const users = JSON.parse(localStorage.getItem('healNestUsers') || '[]');
                const userIndex = users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    users[userIndex].currentStreak = 0;
                    localStorage.setItem('healNestUsers', JSON.stringify(users));
                    
                    const updatedUser = users[userIndex];
                    localStorage.setItem('healNestCurrentUser', JSON.stringify(updatedUser));
                    
                    alert('Streak reset. You can try again tomorrow!');
                    window.location.href = './dashboard.html';
                }
            }
        }
    </script>
</body>
</html>
